@model Kartverket.Web.Models.ObstacleData
@{
    ViewData["Title"] = "Register Obstacle";
}

<section class="mx-auto max-w-4xl pt-10 px-4">
    
    <!-- Logo and Title on same line -->
    <div class="flex items-center justify-center gap-4 mb-8">
        <img src="~/images/KartverketLogo.svg"
             alt="Kartverket"
             class="h-16 w-auto" />
        <h1 class="text-4xl font-medium text-gray-900">
            Register Obstacle
        </h1>
    </div>

    <!-- Form Card -->
    <div class="bg-white shadow-md rounded-2xl border border-gray-200 p-8 mb-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-900 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Obstacle Information
        </h2>

        <form asp-controller="Obstacle" asp-action="DataForm" method="post" class="space-y-6">
            @Html.AntiForgeryToken()
            
            <div class="grid gap-6 md:grid-cols-2">
                <!-- Obstacle Name -->
                <div class="md:col-span-2">
                    <label asp-for="ObstacleName" class="block text-sm font-bold text-gray-600 uppercase tracking-wider mb-2">
                        Obstacle Name
                    </label>
                    <input asp-for="ObstacleName"
                           class="block w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-800 focus:border-transparent"
                           placeholder="e.g., Wall, Ramp, Tower" />
                    <span asp-validation-for="ObstacleName" class="text-sm text-red-600"></span>
                </div>

                <!-- Height -->
                <div>
                    <label asp-for="ObstacleHeight" class="block text-sm font-bold text-gray-600 uppercase tracking-wider mb-2">
                        Height (Feet)
                    </label>
                    <input asp-for="ObstacleHeight" type="number" step="0.01" min="0"
                           class="block w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-800 focus:border-transparent"
                           placeholder="e.g., 150" />
                    <span asp-validation-for="ObstacleHeight" class="text-sm text-red-600"></span>
                </div>

                <!-- Description -->
                <div class="md:col-span-2">
                    <label asp-for="ObstacleDescription" class="block text-sm font-bold text-gray-600 uppercase tracking-wider mb-2">
                        Description
                    </label>
                    <textarea asp-for="ObstacleDescription" rows="4"
                              class="block w-full rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-800 focus:border-transparent"
                              placeholder="Describe the obstacle, materials, location, etc."></textarea>
                    <span asp-validation-for="ObstacleDescription" class="text-sm text-red-600"></span>
                </div>
            </div>

            <!-- Map Section -->
            <div class="bg-white shadow-md rounded-2xl border border-gray-200 p-8 mt-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-900 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Select Location
                </h3>
                <p class="text-sm text-gray-600 mb-4">Click on the map or use the drawing tools to mark the obstacle location</p>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
                    <!-- Map -->
                    <div class="lg:col-span-3">
                        <div id="map" class="w-full h-80 rounded-xl shadow-sm border border-gray-200"></div>
                    </div>

                    <!-- Drawing Tools -->
                    <div class="flex flex-row lg:flex-col gap-3">
                        <button type="button" id="drawPointBtn"
                                class="flex-1 lg:flex-none py-4 rounded-xl text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Point
                        </button>
                        <button type="button" id="drawLineBtn"
                                class="flex-1 lg:flex-none py-4 rounded-xl text-white font-semibold bg-green-600 hover:bg-green-700 transition-colors shadow-md flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                            </svg>
                            Line
                        </button>
                        <button type="button" id="clearDrawBtn"
                                class="flex-1 lg:flex-none py-4 rounded-xl text-white font-semibold bg-gray-600 hover:bg-gray-700 transition-colors shadow-md flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Hidden Fields -->
                <input type="hidden" asp-for="Latitude" id="Latitude" />
                <input type="hidden" asp-for="Longitude" id="Longitude" />
                <input type="hidden" id="GeometryGeoJson" name="GeometryGeoJson" />
                <span asp-validation-for="Latitude" class="text-sm text-red-600"></span>
                <span asp-validation-for="Longitude" class="text-sm text-red-600"></span>

                <!-- Selected Location Display -->
                <div id="selectedLocation" class="hidden mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="text-sm text-gray-600">
                        <strong>Selected location:</strong> 
                        <span id="latDisplay" class="font-mono"></span>, 
                        <span id="lngDisplay" class="font-mono"></span>
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit"
                        class="flex-1 inline-flex items-center justify-center px-6 py-3 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold shadow-md hover:shadow-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Submit Data
                </button>
                <a asp-controller="Home" asp-action="MainPage"
                   class="flex-1 inline-flex items-center justify-center px-6 py-3 rounded-xl bg-gray-400 hover:bg-gray-500 text-white font-semibold shadow-md hover:shadow-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Home
                </a>
            </div>
        </form>
    </div>
</section>

<style>
  .leaflet-touch .leaflet-bar a {
    width: 56px; height: 56px; line-height: 56px; font-size: 18px;
  }
  .leaflet-left .leaflet-control { margin-left: 14px; }
  .leaflet-top  .leaflet-control { margin-top: 14px; }
</style>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <script>
        var map = L.map('map');
        var marker;
        var userLocationCircle;
        var hasCentered = false;
        var activeDrawer = null;
        var isDrawing = false;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var drawControl = new L.Control.Draw({ draw: false, edit: false });

        function startDraw(type) {
            if (activeDrawer) { activeDrawer.disable(); activeDrawer = null; }
            isDrawing = true;

            if (type === 'marker') {
              activeDrawer = new L.Draw.Marker(map, drawControl.options.marker || {});
            } else if (type === 'polyline') {
            activeDrawer = new L.Draw.Polyline(map, drawControl.options.polyline || {});
         }
         activeDrawer.enable();
        }

    document.getElementById('drawPointBtn').addEventListener('click', function () {
      startDraw('marker');
    });
    document.getElementById('drawLineBtn').addEventListener('click', function () {
      startDraw('polyline');
    });
    document.getElementById('clearDrawBtn').addEventListener('click', function () {
      drawnItems.clearLayers();
      captureGeoJson();
      document.getElementById('selectedLocation').classList.add('hidden');
    });

    map.on('draw:drawstart',  function(){ isDrawing = true;  });
    map.on('draw:drawstop',   function(){ isDrawing = false; activeDrawer = null; });

        map.on(L.Draw.Event.CREATED, function (e) {
            drawnItems.addLayer(e.layer);

            if (e.layerType === 'marker') {
            var p = e.layer.getLatLng();
            document.getElementById('Latitude').value  = p.lat.toFixed(6);
            document.getElementById('Longitude').value = p.lng.toFixed(6);
            var latDisp = document.getElementById('latDisplay');
            var lngDisp = document.getElementById('lngDisplay');
            if (latDisp && lngDisp) { 
                latDisp.textContent = p.lat.toFixed(6); 
                lngDisp.textContent = p.lng.toFixed(6);
                document.getElementById('selectedLocation').classList.remove('hidden');
            }
            }

            if (e.layerType === 'polyline') {
            var pts = e.layer.getLatLngs();
            if (pts.length > 0) {
                document.getElementById('Latitude').value  = pts[0].lat.toFixed(6);
                document.getElementById('Longitude').value = pts[0].lng.toFixed(6);
                var latDisp = document.getElementById('latDisplay');
                var lngDisp = document.getElementById('lngDisplay');
                if (latDisp && lngDisp) { 
                    latDisp.textContent = pts[0].lat.toFixed(6); 
                    lngDisp.textContent = pts[0].lng.toFixed(6);
                    document.getElementById('selectedLocation').classList.remove('hidden');
                }
            }
            }

            captureGeoJson();
        });

        map.on('draw:edited',  captureGeoJson);
        map.on('draw:deleted', captureGeoJson);

        function captureGeoJson() {
            var hidden = document.getElementById('GeometryGeoJson');
            if (!hidden) return;
            hidden.value = JSON.stringify(drawnItems.toGeoJSON());
        }    
        
        function onLocationFound(e) {
            var radius = e.accuracy / 2;

            if (!hasCentered) {
            map.setView(e.latlng, 13);
            hasCentered = true;
           }

            if (marker) {
                map.removeLayer(marker);
            }

            if (userLocationCircle) {
                map.removeLayer(userLocationCircle);
            }

            marker = L.marker(e.latlng).addTo(map)
                .bindPopup("Du er innenfor " + radius.toFixed(0) + " meter fra dette punktet")
                .openPopup();

            userLocationCircle = L.circle(e.latlng, radius).addTo(map);

            document.getElementById('Latitude').value = e.latlng.lat;
            document.getElementById('Longitude').value = e.latlng.lng;

            document.getElementById('latDisplay').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('lngDisplay').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('selectedLocation').classList.remove('hidden');
        }

        function onLocationError(e) {
            console.error("Feil ved henting av posisjon:", e.message);
            
            var fallbackLocation = [59.9139, 10.7522];
            map.setView(fallbackLocation, 10);
            
            marker = L.marker(fallbackLocation).addTo(map)
                .bindPopup("Kunne ikke hente din posisjon. Kartet viser Oslo sentrum.")
                .openPopup();

            document.getElementById('Latitude').value = fallbackLocation[0];
            document.getElementById('Longitude').value = fallbackLocation[1];
            
            document.getElementById('latDisplay').textContent = fallbackLocation[0].toFixed(6);
            document.getElementById('lngDisplay').textContent = fallbackLocation[1].toFixed(6);
            document.getElementById('selectedLocation').classList.remove('hidden');

            alert("Kunne ikke hente din posisjon. Vennligst velg en lokasjon manuelt på kartet.");
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        map.locate({ 
            watch: true, 
            setView: false, 
            maxZoom: 16,
            timeout: 10000,
            maximumAge: 30000
        });

        map.on('click', function (e) {
            if (isDrawing) return;
            if (marker) {
                map.removeLayer(marker);
            }

            if (userLocationCircle) {
                map.removeLayer(userLocationCircle);
            }

            marker = L.marker(e.latlng).addTo(map);

            document.getElementById('Latitude').value = e.latlng.lat;
            document.getElementById('Longitude').value = e.latlng.lng;

            drawnItems.clearLayers();
            drawnItems.addLayer(marker);
            captureGeoJson();

            document.getElementById('latDisplay').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('lngDisplay').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('selectedLocation').classList.remove('hidden');
        });

        document.querySelector('form').addEventListener('submit', function (e) {
            var lat = document.getElementById('Latitude').value;
            var lng = document.getElementById('Longitude').value;
            
            if (!lat || !lng) {
                e.preventDefault();
                alert('Vennligst velg en lokasjon på kartet før du sender inn skjemaet.');
                return;
            }

        if (typeof captureGeoJson === 'function') {
          captureGeoJson();
        }
        });
    </script>

    <script>
        (function () {
            var $form = $('form').not('header form');
            var $submit = $form.find('button[type="submit"]').first();
            var originalText = $submit.text().trim();

            function hasJQueryValidate() {
                return typeof $form.valid === 'function';
            }

            function isFormValid() {
                if (hasJQueryValidate()) {
                    return $form.valid();
                }

                var valid = true;
                $form.find('[data-val-required]').each(function () {
                    var $el = $(this);
                    var val = $el.val();
                    if (!val || val.toString().trim() === '') {
                        valid = false;
                        return false;
                    }
                });
                return valid;
            }

            function updateSubmitText() {
                try {
                    if (isFormValid()) {
                        $submit.text(originalText);
                    } else {
                        $submit.text('Submit Draft');
                    }
                } catch (ex) {
                    console.error('updateSubmitText error', ex);
                    $submit.text(originalText);
                }
            }

            $(function () {
                setTimeout(updateSubmitText, 50);

                $form.on('input change keyup', 'input, textarea, select', function () {
                    updateSubmitText();
                });

                $form.on('submit', function () {
                    updateSubmitText();
                });
            });
        })();
    </script>
}