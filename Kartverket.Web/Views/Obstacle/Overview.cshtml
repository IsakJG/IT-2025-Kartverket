@model Kartverket.Web.Models.ObstacleData

@* ---------------------------------------------------------------------------
    View: Overview (Receipt)
    Description: 
        Kvitteringsside som vises etter vellykket innsending.
        Viser detaljer om hinderet og et statisk kartutsnitt.
    --------------------------------------------------------------------------- 
*@

@{
    ViewData["Title"] = "Overview";
}

<section class="mx-auto max-w-4xl pt-10 px-4">
    
    <div class="flex items-center justify-center gap-4 mb-8">
        @* Url.Content sikrer robust bildesti *@
        <img src="@Url.Content("~/images/Kartverketlogo.svg")"
             alt="Kartverket"
             class="h-16 w-auto" />
        <h1 class="text-4xl font-medium text-gray-900">
            Obstacle Overview
        </h1>
    </div>

    <div class="text-center mb-8">
        <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Successfully Submitted
        </span>
    </div>

    <div class="bg-white shadow-md rounded-2xl border border-gray-200 p-8 mb-6">
        <h2 class="text-2xl font-semibold mb-6 text-gray-900 flex items-center">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Obstacle Details
        </h2>
        
        <div class="space-y-4">
            <div class="flex items-start py-3 border-b border-gray-200">
                <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider w-40 flex-shrink-0">Obstacle Name</dt>
                <dd class="text-base text-gray-900 font-semibold">@Model.ObstacleName</dd>
            </div>

            <div class="flex items-start py-3 border-b border-gray-200">
                <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider w-40 flex-shrink-0">Height</dt>
                <dd class="text-base text-gray-900">@Model.ObstacleHeight feet</dd>
            </div>

            <div class="flex items-start py-3 border-b border-gray-200">
                <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider w-40 flex-shrink-0">Location</dt>
                <dd class="text-sm text-gray-900 font-mono">
                    @* DEV NOTE: Logic for parsing GeoJSON is kept here for simplicity in this version.
                       In a larger refactoring, this string formatting should move to the ViewModel.
                    *@
                    @{
                        string locationDisplay = $"{Model.Latitude:F6}, {Model.Longitude:F6}";
                        
                        // Enkel logikk for å sjekke om det er en linje (LineString) for å vise sluttpunkt
                        if (!string.IsNullOrEmpty(Model.GeometryGeoJson) && Model.GeometryGeoJson.Contains("LineString"))
                        {
                            try 
                            {
                                // Forenklet parsing for å unngå tung logikk i Viewet
                                var geo = System.Text.Json.JsonDocument.Parse(Model.GeometryGeoJson);
                                var feats = geo.RootElement.GetProperty("features");
                                var coords = feats[0].GetProperty("geometry").GetProperty("coordinates");
                                var last = coords[coords.GetArrayLength() - 1];
                                
                                locationDisplay += $" → {last[1].GetDouble():F6}, {last[0].GetDouble():F6}";
                            }
                            catch { /* Fallback til kun startpunkt ved feil */ }
                        }
                    }
                    @locationDisplay
                </dd>
            </div>


            <div class="flex items-start py-3">
                <dt class="text-sm font-bold text-gray-600 uppercase tracking-wider w-40 flex-shrink-0">Description</dt>
                <dd class="text-base text-gray-700 leading-relaxed">@Model.ObstacleDescription</dd>
            </div>
        </div>
    </div>

    <div class="bg-white shadow-md rounded-2xl border border-gray-200 p-8 mb-6">
        <h3 class="text-xl font-semibold mb-6 text-gray-900 flex items-center">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Location on Map
        </h3>
        <div id="map" class="w-full h-80 rounded-xl shadow-sm border border-gray-200"></div>
    </div>

    <div class="text-center mb-6">
        <a asp-controller="Home" asp-action="MainPage"
           class="inline-flex items-center px-6 py-3 rounded-xl bg-gray-400 hover:bg-gray-500 text-white font-semibold shadow-md hover:shadow-lg transition-all">
            <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Home
        </a>
    </div>

</section>

@section Scripts {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Init Map (Read-Only)
        var map = L.map('map', { 
            zoomControl: false, // Cleaner look for receipt
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false
        }).setView([@Model.Latitude, @Model.Longitude], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        @if (!string.IsNullOrEmpty(Model.GeometryGeoJson))
        {
            @:try {
                @:var geoJsonData = @Html.Raw(Model.GeometryGeoJson);
                @:var geoJsonLayer = L.geoJSON(geoJsonData).addTo(map);
                @:map.fitBounds(geoJsonLayer.getBounds(), { padding: [50, 50] });
            @:} catch (e) {
                @:// Fallback if GeoJSON fails
                @:L.marker([@Model.Latitude, @Model.Longitude]).addTo(map);
            @:}
        }
        else
        {
            @:L.marker([@Model.Latitude, @Model.Longitude]).addTo(map);
        }
    </script>
}